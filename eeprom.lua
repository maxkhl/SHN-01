hive={id="SHN-NEXUS-CEB7",address=nil}node={id="SHN-NEXUS-CEB7-SOLAR",address=nil}adler32=(function()adler32={}function adler32.run(s)local prime=65521 local s1,s2=1,0 for i=1,#s do s1=s1+s:byte(i)s2=s2+s1 end s1=s1%prime s2=s2%prime return(s2<<16)+s1 end return adler32 end)()gatePort=2011 filePort=2031 corePort=2015 function getComp(name)for a,c in pairs(component.list(name))do return component.proxy(a),a end end function sleep(sec)local evts,deadline={},computer.uptime()+(sec or 0)repeat local left=deadline-computer.uptime()if left<=0 then break end local e={computer.pullSignal(left)}if e[1]then evts[#evts+1]=e end until computer.uptime()>=deadline return evts end mdm,node.address=getComp("modem")while mdm==nil do computer.beep(2000,0.5)sleep(1)mdm,node.address=getComp("modem")end local gpu=getComp("gpu")local _,screen=getComp("screen")local w,h=50,16 if gpu and screen then gpu.bind(screen)w,h=gpu.getResolution()end local consoleY=1 function cls()if gpu then gpu.fill(1,1,w,h," ")consoleY=1 end end function print(text)if gpu then gpu.set(1,consoleY,text)consoleY=consoleY+1 if consoleY>h then consoleY=1 end end end if not mdm.isOpen(gatePort)then mdm.open(gatePort)end if not mdm.isOpen(filePort)then mdm.open(filePort)end cls()print("Node: "..node.id)print("Hive: "..hive.id)local stage2Buffer={}local stage2Total=0 local stage2Retries=0 function send(port,...)if hive.address then mdm.send(hive.address,port,...)end end function criticalError(msg)computer.beep(2000,0.08)computer.beep(180,0.3)computer.beep(180,0.3)send(corePort,"ERROR",nil,tostring(msg))print("Critical Error: "..tostring(msg))sleep(2)computer.shutdown(true)end function handshake()mdm.broadcast(gatePort,"handshake",nil,node.id,hive.id)print("Sent handshake broadcast")end function handleTransmitPacket(sequence,sessionid,seqNum,totalPackets,checksum,data)if seqNum==1 then stage2Buffer={}stage2Total=totalPackets end if adler32.run(data)~=checksum then print("Packet "..seqNum.." checksum mismatch! Expected: "..checksum..", Got: "..adler32.run(data))return end stage2Buffer[seqNum]=data send(filePort,sequence,sessionid,"TRANSMIT_ACK",seqNum)end function handleTransmitComplete(sequence,sessionid,totalPackets,checksumExpected)local content=table.concat(stage2Buffer,"",1,totalPackets)stage2Buffer,stage2Total,stage2Retries={},0,0 local stage2Func,err=load(content,"stage2","t",_G)if not stage2Func then criticalError("Stage 2 compile failed: "..tostring(err))end print("Stage 2 compiled successfully, executing...")local success,result=pcall(stage2Func)if not success then criticalError("Stage 2 execution failed: "..tostring(result))end return true end local connected=false local lastHandshake=0 lastHandshake=-9999999 while true do local events=sleep(1.0)if not connected then local now=computer.uptime()if now-lastHandshake>=20 then handshake()lastHandshake=now end end for _,event in ipairs(events)do if event[1]=="modem_message"then local _,locAddr,remAddr,port,dist,sequence,sessionid,command,d0,d1,d2,d3=table.unpack(event)command=string.upper(command or"")if remAddr==node.address then goto continue end if connected and hive.address and remAddr~=hive.address then goto continue end if command=="HANDSHAKE_ACK"and d0==node.id and d1==hive.id then hive.address=remAddr connected=true print("Connected!")print("Requesting Stage 2...")computer.beep(600,0.1)computer.beep(900,0.1)computer.beep(1200,0.2)send(port,sequence,sessionid,"STAGE2_REQUEST")elseif command=="TRANSMIT_PACKET"then local seqNum=d0 local totalPackets=d1 local checksum=d2 local data=d3 print("Received packet "..seqNum.." of "..totalPackets)handleTransmitPacket(sequence,sessionid,seqNum,totalPackets,checksum,data)elseif command=="TRANSMIT_COMPLETE"then local totalPackets=d0 local checksum=d1 if handleTransmitComplete(totalPackets,checksum)then print("Starting Stage 2...")break end elseif command=="RESTART"and d0==node.id then computer.beep(1000,0.1)computer.beep(650,0.15)computer.beep(300,0.4)computer.shutdown(true)end end::continue::end end