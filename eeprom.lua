local hive={id="SHN-NEXUS-CEB7",address=nil}local node={id="SHN-NEXUS-CEB7-SOLAR",address=nil}local gatePort=2011 local filePort=2031 local corePort=2015 function getComp(name)for a,c in pairs(component.list(name))do return component.proxy(a),a end end mdm,node.address=getComp("modem")while mdm==nil do computer.beep(2000,0.5)computer.sleep(1)mdm,node.address=getComp("modem")end local gpu=getComp("gpu")local _,screen=getComp("screen")local w,h=50,16 if gpu and screen then gpu.bind(screen)w,h=gpu.getResolution()end local consoleY=1 function cls()if gpu then gpu.fill(1,1,w,h," ")consoleY=1 end end function print(text)if gpu then gpu.set(1,consoleY,text)consoleY=consoleY+1 if consoleY>h then consoleY=1 end end end if not mdm.isOpen(gatePort)then mdm.open(gatePort)end if not mdm.isOpen(filePort)then mdm.open(filePort)end cls()print("Node: "..node.id)print("Hive: "..hive.id)print("Connecting...")local stage2Buffer={}local stage2Total=0 local stage2Retries=0 function send(port,...)if hive.address then mdm.send(hive.address,port,...)end end function criticalError(msg)computer.beep(2000,0.08)computer.beep(180,0.3)computer.beep(180,0.3)send(corePort,"ERROR",tostring(msg))computer.sleep(2)computer.shutdown(true)end function handshake()mdm.broadcast(gatePort,"handshake",node.id,hive.id)print("Sent handshake broadcast")end function handleTransmitPacket(seqNum,totalPackets,data,checksum)if seqNum==1 then stage2Buffer={}stage2Total=totalPackets end stage2Buffer[seqNum]=data send(filePort,"transmit_ack",seqNum)end function handleTransmitComplete(totalPackets,checksumExpected)local missing={}for i=1,totalPackets do if not stage2Buffer[i]then table.insert(missing,i)end end if#missing>0 then for _,seqNum in ipairs(missing)do send(filePort,"transmit_request",seqNum)end return false end local content=""for i=1,totalPackets do content=content..(stage2Buffer[i]or"")end local actualChecksum=computeMD5(content)if actualChecksum~=checksumExpected then stage2Retries=stage2Retries+1 if stage2Retries>=10 then criticalError("Stage 2 checksum failed 10 times")end send(filePort,"CHECKSUM_FAIL")stage2Buffer={}return false end stage2Buffer={}stage2Total=0 stage2Retries=0 local success,result=pcall(function()local stage2Func,err=load(content,"stage2","t",_G)if not stage2Func then error("Stage 2 compile failed: "..tostring(err))end return stage2Func()end)if not success then criticalError("Stage 2 execution failed: "..tostring(result))end return true end function computeMD5(str)return str end local connected=false local lastHandshake=0 function sleep(sec)local evts,deadline={},computer.uptime()+(sec or 0)repeat local left=deadline-computer.uptime()if left<=0 then break end local e={computer.pullSignal(left)}if e[1]then evts[#evts+1]=e end until computer.uptime()>=deadline return evts end lastHandshake=-9999999 while true do local events=sleep(1.0)if not connected then local now=computer.uptime()if now-lastHandshake>=20 then print("Not connected, sending handshake...")handshake()lastHandshake=now end end for _,event in ipairs(events)do if event[1]=="modem_message"then local _,locAddr,remAddr,port,dist,command,d0,d1,d2,d3=table.unpack(event)if remAddr==node.address then goto continue end if connected and hive.address and remAddr~=hive.address then goto continue end if command=="handshake_ack"and d0==node.id and d1==hive.id then hive.address=remAddr connected=true print("Connected!")print("Downloading Stage 2...")computer.beep(600,0.1)computer.beep(900,0.1)computer.beep(1200,0.2)elseif command=="transmit_packet"then local seqNum=d0 local totalPackets=d1 local data=d2 handleTransmitPacket(seqNum,totalPackets,data)elseif command=="transmit_complete"then local totalPackets=d0 local checksum=d1 print("Stage 2 complete")if handleTransmitComplete(totalPackets,checksum)then print("Starting Stage 2...")break end elseif command=="restart"and d0==node.id then computer.beep(1000,0.1)computer.beep(650,0.15)computer.beep(300,0.4)computer.shutdown(true)end end::continue::end end