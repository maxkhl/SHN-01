local handshake = newClass(class("../../sequence"))

function handshake:constructor(hive, protocol)
    assert(self, "Must be called on a object")
    self.base:constructor("handshake",
        function(message)
            -- Server-side handshake logic
            print("Handshake initiated for address:", message.remoteAddress)

            local nodes = getNodes()
            local node = nodes[message.data[1]]
            if not node then
                error("Unknown node attempting to handshake: " .. tostring(message.data[1] .. " at " .. tostring(message.remoteAddress) .. "\nConnection refused"))
                return nil
            end

            -- Simulate some processing
            coroutine.yield("Processing server handshake...")

            -- Create a client object for this connection
            local clientClass = class("../../node.class")
            local client = clientClass:new(message.remoteAddress, message.protocol)

            print("Server-side handshake completed")
            return nil
        end)
end

return handshake
